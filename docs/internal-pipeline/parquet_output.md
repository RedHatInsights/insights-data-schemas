---
layout: default
---
\[[Front page](../index.md)\] \[[Internal data pipeline](../internal_data_pipeline.md)\]

# Format of received Kafka messages from `ccx-XXX-insights-operator-archive-features` topic

Parquet Factory is a program that can read data from several data sources,
aggregate the data received from them and generate a set of Parquet files with
the aggregated data, storing them in a selected S3 or Ceph bucket. It is used
to generate different data aggregations in the CCX Internal Data Pipeline,
reading data from Kafka topics and Thanos service.

## Schema version

1 (unofficial)

## Description

Three types of Parquet files (tables) are generated by Parquet Factory service:

* `cluster_info`
* `rule_hits`
* `cluster_thanos_info`

Format of these tables are described below.

## Basic format

---
**NOTE**

byte array is used in Parquet files also to represent string (among other data
structures). For more information please look at
[https://parquet.apache.org/documentation/latest/](https://parquet.apache.org/documentation/latest/).

---

### Format of `cluster_info` table

* `cluster_id` (byte array) cluster ID represented as UUID
* `current_version` (byte array) cluster version represented as string
* `platform` (byte array) cluster platform specification
* `collected_at` (timestamp) timestamp of report represented with millisecond precision
* `desired_version` (byte array) desired cluster version represented as string
* `archive_path` (byte array) path to the object stored in Ceph
* `initial_version` (byte array) initial cluster version represented as string


#### `cluster_id` attribute

`cluster_id` uses its canonical textual representation: the 16 octets of a
UUID are represented as 32 hexadecimal (base-16) digits, displayed in five
groups separated by hyphens, in the form 8-4-4-4-12 for a total of 36
characters (32 hexadecimal characters and 4 hyphens). For more information
please look at
[https://en.wikipedia.org/wiki/Universally_unique_identifier](https://en.wikipedia.org/wiki/Universally_unique_identifier).

An example of UUID:

```
3ba9b042-b8b8-4714-98e9-17915c2eeb95
```

#### `current_version` attribute

Current cluster version represented as string, for example "4.5.24" or even
"4.6.0-0.ci.test-2020-12-01-123456-ci-xx-yyyyyyy"


#### `platform` attribute

Cluster platform specification, for example "BareMetal", "OpenStack", "Azure"
etc.


#### `collected_at` attribute

Timestamp of report represented with millisecond precision, for example
"2021-02-08 00:22:19" (this is the display format, the precision is higher
internally)


#### `desired_version` attribute

Desired cluster version represented as string, for example "4.5.24" or even
"4.6.0-0.ci.test-2020-12-01-123456-ci-xx-yyyyyyy"


#### `archive_path` attribute

This attribute contains path to object stored in Ceph. It must be real path
with chunks splitted by slash character. The format of path is:

```
archives/compressed/{PREFIX}/{CLUSTER_ID}/{YEAR+MONTH}/{DAY}/{ID}.tar.gz |
```

An example of path:

```
archives/compressed/0a/0aaaaaaa-bbbb-cccc-dddd-ffffffffffff/202102/08/003201.tar.gz |
```

#### `initial_version` attribute

Initial cluster version represented as string, for example "4.5.24" or even
"4.6.0-0.ci.test-2020-12-01-123456-ci-xx-yyyyyyy"

### Format of `rule_hits` table

* `cluster_id` (byte array) cluster ID represented as UUID
* `rule_id` (byte array)
* `collected_at` (timestamp) timestamp of report represented in milliseconds
* `archive_path` (byte array) path to the object stored in Ceph


#### `cluster_id` attribute

`cluster_id` uses its canonical textual representation: the 16 octets of a
UUID are represented as 32 hexadecimal (base-16) digits, displayed in five
groups separated by hyphens, in the form 8-4-4-4-12 for a total of 36
characters (32 hexadecimal characters and 4 hyphens). For more information
please look at
[https://en.wikipedia.org/wiki/Universally_unique_identifier](https://en.wikipedia.org/wiki/Universally_unique_identifier).

An example of UUID:

```
3ba9b042-b8b8-4714-98e9-17915c2eeb95
```

#### `rule_id` attribute

It contains rule name and a key that are joined by | character.

Example of rule IDs:

```
pods_check_containers|POD_CONTAINER_ISSUE
operators_check|OPERATOR_ISSUE
pods_check|POD_ISSUE
```

#### `collected_at` attribute

Timestamp of report represented with millisecond precision, for example
"2021-02-08 00:22:19" (this is the display format, the precision is higher
internally)


#### `archive_path` attribute

This attribute contains path to object stored in Ceph. It must be real path
with chunks splitted by slash character. The format of path is:

```
archives/compressed/{PREFIX}/{CLUSTER_ID}/{YEAR+MONTH}/{DAY}/{ID}.tar.gz |
```

An example of path:

```
archives/compressed/0a/0aaaaaaa-bbbb-cccc-dddd-ffffffffffff/202102/08/003201.tar.gz |
```


### Format of `cluster_thanos_info` table

* `cluster_id` (byte array) cluster ID represented as UUID
* `ebs_account` (byte array) account number
* `email_domain` (byte array) an e-mail domain
* `managed` (bool) flag whether the cluster is managed or not
* `support` (byte array) specifies the support level of a cluster
* `collected_at` (timestamp) timestamp of report represented with millisecond precision


#### `cluster_id` attribute

`cluster_id` uses its canonical textual representation: the 16 octets of a
UUID are represented as 32 hexadecimal (base-16) digits, displayed in five
groups separated by hyphens, in the form 8-4-4-4-12 for a total of 36
characters (32 hexadecimal characters and 4 hyphens). For more information
please look at
[https://en.wikipedia.org/wiki/Universally_unique_identifier](https://en.wikipedia.org/wiki/Universally_unique_identifier).

An example of UUID:

```
3ba9b042-b8b8-4714-98e9-17915c2eeb95
```

#### `ebs_account` attribute

Account number, which is usually a positive integer represented as string, for
example "123456".

#### `email_domain` attribute

An e-mail domain, for example: "redhat.com"

#### `managed` (bool) attribute

Boolean flag containing info if the cluster is managed or not.

#### `support` attribute

Specifies the level of (customer) support for this cluster.

#### `collected_at` attribute

Timestamp of report represented with millisecond precision, for example
"2021-02-08 00:22:19" (this is the display format, the precision is higher
internally)


## Possible enhancements

* Version (positive integer) should be included in the generated Parquet files
  into separate column.
* For strings with fixed (and known) length, fixed_len_byte_array type should
  be used to speedup Parquet file generation and consuming.
* Using dictionaries for `cluster_id` might not be optimal - more study needed.

## Examples

### Content of `cluster_info` table

```
+--------------------------------------+-------------------+------------+---------------------+-------------------+-------------------+-------------------------------------------------------------------------------------+
| cluster_id                           | cluster_version   | platform   | collected_at        | desired_version   | initial_version   | archive_path                                                                        |
|--------------------------------------+-------------------+------------+---------------------+-------------------+-------------------+-------------------------------------------------------------------------------------|
| 1e1ec4a5-1234-4f6c-838d-4e1c19300787 | 4.6.16            | None       | 2021-03-18 11:20:21 | 4.6.16            | 4.6.16            | archives/compressed/1e/1e1ec4a5-1234-4f6c-838d-4e1c19300787/202103/18/112021.tar.gz |
| 5e6538de-1234-4740-abbe-93afdef885a7 | 4.7.0             | None       | 2021-03-18 11:54:37 | 4.7.0             | 4.7.0             | archives/compressed/5e/5e6538de-1234-4740-abbe-93afdef885a7/202103/18/115437.tar.gz |
| e9ae142e-1234-4c49-a937-80f57a7abb52 | 4.6.16            | None       | 2021-03-18 11:04:22 | 4.6.16            | 4.6.16            | archives/compressed/e9/e9ae142e-1234-4c49-a937-80f57a7abb52/202103/18/110422.tar.gz |
| d8757ed6-1234-4860-8065-983f838e581e | 4.6.17            | None       | 2021-03-18 11:13:50 | 4.6.17            | 4.6.17            | archives/compressed/d8/d8757ed6-1234-4860-8065-983f838e581e/202103/18/111350.tar.gz |
| 735c7c4d-1234-438f-a494-225f664c72a4 | 4.6.16            | VSphere    | 2021-03-18 11:38:46 | 4.6.16            | 4.3.28            | archives/compressed/73/735c7c4d-1234-438f-a494-225f664c72a4/202103/18/113846.tar.gz |
+--------------------------------------+-------------------+------------+---------------------+-------------------+-------------------+-------------------------------------------------------------------------------------+
```
---
**NOTE**

`cluster_id` is mocked, these clusters are not real.

---

### Content of `rule_hits` table

```
+--------------------------------------+-------------------------------------------+---------------------+-------------------------------------------------------------------------------------+
| cluster_id                           | rule_id                                   | collected_at        | archive_path                                                                        |
|--------------------------------------+-------------------------------------------+---------------------+-------------------------------------------------------------------------------------|
| 00000000-0000-0000-0000-000000000000 | pods_check_containers|POD_CONTAINER_ISSUE | 2021-02-08 00:59:34 | archives/compressed/00/00000000-0000-0000-0000-000000000000/202102/08/005934.tar.gz |
| 11111111-1111-1111-1111-111111111111 | operators_check|OPERATOR_ISSUE            | 2021-02-08 00:59:34 | archives/compressed/11/11111111-1111-1111-1111-111111111111/202102/08/005934.tar.gz |
| 22222222-2222-2222-2222-222222222222 | pods_check|POD_ISSUE                      | 2021-02-08 00:59:34 | archives/compressed/22/22222222-2222-2222-2222-222222222222/202102/08/005934.tar.gz |
+--------------------------------------+-------------------------------------------+---------------------+-------------------------------------------------------------------------------------+
```

---
**NOTE**

`cluster_id` is mocked, these clusters are not real.

---

### Content of `cluster_thanos_info` table

```
+--------------------------------------+---------------+-------------------+-----------+--------------+---------------------+
| cluster_id                           |   ebs_account | email_domain      | managed   | support      | collected_at        |
|--------------------------------------+---------------+-------------------+-----------+--------------+---------------------|
| 12345678-ec5b-4552-9e2d-76c7bc4dee8f |    b'1234567' | us.ibm.com        | False     | None         | 2021-03-18 07:59:00 |
| 12345678-ef92-4ee2-84c9-478f99b76fdb |    b'1234500' | customer1.com     | False     | Self-Support | 2021-03-18 07:59:00 |
| 12345678-c145-4b12-850b-56a9de766d9c |    b'1234567' | us.ibm.com        | False     | None         | 2021-03-18 07:59:00 |
| 12345678-6d6f-490d-a6e2-0e01fbbb962d |    b'1234600' | customer2.com     | False     | None         | 2021-03-18 07:59:00 |
| 12345678-bde1-4e51-84e7-378030599471 |    b'1234700' | customer3.com     | False     | Premium      | 2021-03-18 07:59:00 |
| 12345678-f0c3-4b44-80d2-ed6b5fc6c95f |    b'1234567' | us.ibm.com        | False     | Eval         | 2021-03-18 07:59:00 |
| 12345678-8eb8-4d85-828d-ce940f1b9778 |    b'1234800' | us.ibm.com        | False     | Eval         | 2021-03-18 07:59:00 |
| 12345678-8169-4a66-8c17-ce3a15eb81d3 |     b'123000' | customer4.co      | False     | Premium      | 2021-03-18 07:59:00 |
+--------------------------------------+---------------+-------------------+-----------+--------------+---------------------+

```

---
**NOTE**

`cluster_id`, `ebs_account`, `email_domain` are mocked.

---
